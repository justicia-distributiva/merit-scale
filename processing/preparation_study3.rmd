---
title: "Data preparation Study 3 - Merit Scale"
date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
output:
  bookdown::html_document2:
    number_sections: true
    toc: true
    toc_float:
        collapsed: false
    toc_depth: 2
    code_folding: "hide"
editor_options:
  chunk_output_type: console
---

```{r include=FALSE}
# Knitr options

knitr::opts_chunk$set(warning = FALSE,message = FALSE, cache = FALSE,results = "hold")
knitr::opts_knit$set(root.dir = "../")
options(scipen=999)
rm(list=ls())
options(knitr.kable.NA = '')
```

This is the preparation code of the data for Study 3:  Additional validity analyses. The prepared data is `data_s3_conv.RData` in "Convergence section" and `data_s3_conv.RData` in "Invariance section"


# Convergence

## Libraries
```{r}
pacman::p_load(haven, sjPlot, dplyr, tidyr, mice, lavaan, stargazer, corrplot, polycor, knitr, kableExtra, summarytools, sjlabelled)
```


## Load original data

```{r}
dat04w3 <- sjlabelled::read_spss("input/data/original/Estudio_3_ola3.sav",verbose = F)
dim(dat04w3) 
```


## Estimate the measurement model with the dimensions of the merit-scale and other meritocracy scales

The following code creates new variables corresponding to the four dimensions of the PPM scale. Based on the measurement model, four factorial scores are created. To retrieve cases the "mice" function is used

```{r results='hide'}

model <- '
perc_merit =~  meritv03_perc_effort + meritv03_perc_talent
perc_nmerit=~ meritv03_perc_wpart + meritv03_perc_netw
pref_merit =~ meritv03_pref_effort + meritv03_pref_talent
pref_nmerit=~ meritv03_pref_wpart + meritv03_pref_netw

nbmerit =~  nb_merit_1 + nb_merit_2 + nb_merit_3 + nb_merit_4 + nb_merit_5 + nb_merit_6 + nb_merit_7 

perc_merit ~~  get_ah_1
perc_nmerit ~~ get_ah_1
pref_merit ~~ get_ah_1
pref_nmerit ~~ get_ah_1
nbmerit ~~ get_ah_1

perc_merit ~~  get_ah_5
perc_nmerit ~~ get_ah_5
pref_merit ~~ get_ah_5
pref_nmerit ~~ get_ah_5
nbmerit ~~ get_ah_5

perc_merit ~~  nbmerit
perc_nmerit ~~ nbmerit
pref_merit ~~ nbmerit
pref_nmerit ~~ nbmerit

'



fit3_c1=lavaan::cfa(model,data = dat04w3)

fit3_o1=lavaan::cfa(model,data = dat04w3, estimator = "DWLS", ordered = c("meritv03_perc_effort","meritv03_perc_talent",
"meritv03_perc_wpart","meritv03_perc_netw","meritv03_pref_effort","meritv03_pref_talent","meritv03_pref_wpart","meritv03_pref_netw" ,"nb_merit_1" , "nb_merit_2" , "nb_merit_3" , "nb_merit_4" , "nb_merit_5" , "nb_merit_6" , "nb_merit_7","get_ah_1","get_ah_5"))


cargas1 = left_join(x = standardizedsolution(fit3_c1) %>% filter(op=="=~") %>% dplyr::select(lhs,rhs,est.std),y = standardizedsolution(fit3_o1) %>% filter(op=="=~") %>% dplyr::select(lhs,rhs,est.std),c("lhs","rhs"))

kable(cargas1,
      format = "html",digits = 2, booktabs=T, caption = "Cargas factoriales",escape = FALSE) %>%  
   kable_styling(full_width = T, font_size = 8,  bootstrap_options=c("striped", "bordered")) %>%
     column_spec(column = 1,width = "2 cm") %>% 
   column_spec(column = 2,width = "11 cm") %>%
  column_spec(column = 3,width = "1 cm") %>%
  column_spec(column = 4,width = "1 cm") %>%
      collapse_rows(columns = 1,valign = "middle")

pacman::p_load(dplyr, kableExtra, knitr)

# extract fit indices from models and add to table
sum_fit1<- dplyr::bind_rows(fitmeasures(fit3_c1)[c("chisq","df","cfi","tli","rmsea","srmr")],
                    fitmeasures(fit3_o1)[c("chisq","df","cfi","tli","rmsea","srmr")])


# Customize object
sum_fit1$mod <- c("Continuous","Ordinals")
sum_fit1$nobs <- c(nobs(fit3_c1),nobs(fit3_o1))
sum_fit1$est <- c("MLR","DWLS")
sum_fit1 <- dplyr::select(sum_fit1,mod,nobs,est,everything())
colnames <- c("Treated as","$N$","Estimator","$\\chi^2$","df","CFI","TLI","RMSEA","SRMR")

# Create table
table_cfa_fits1 <-kable(sum_fit1, format="html", digits=3, booktabs=T, col.names=colnames, escape = FALSE) %>% kable_styling(full_width = F, font_size = 10)
table_cfa_fits1

```


## Calculate the correlations between the scale of this work and other measures of meritocratic beliefs.

```{r}

correlaciones = standardizedsolution(fit3_o1) %>% filter(op=="~~") %>% 
                dplyr::select(lhs,rhs,est.std) %>% 
                dplyr::filter(lhs== "perc_merit" | 
                             lhs== "pref_merit" | 
                             lhs== "perc_nmerit"| 
                             lhs== "pref_nmerit") %>%
                pivot_wider(names_from = "rhs", values_from = "est.std") %>% 
                dplyr::select(lhs,get_ah_1, get_ah_5, nbmerit) %>% 
                mutate(merit_scale=
                      case_when(lhs == "perc_merit" ~  "Meritocratic perception",
                                lhs=="perc_nmerit" ~ "Unmeritocratic perception", 
                                lhs =="pref_merit" ~ "Meritocratic preferences" , 
                                lhs =="pref_nmerit" ~ "Unmeritocratic preferences"))%>% 
                select(merit_scale, get_ah_1, get_ah_5,nbmerit)

kable(correlaciones,col.names = c("Merit-Scale","Social Origin ", "Hard Work " , "Personal wherewithal - NBI"),
      format = "html",digits = 2, booktabs=T,escape = FALSE) %>%  
      kable_styling(full_width = T, font_size = 8,  bootstrap_options=c("striped", "bordered")) %>%
      column_spec(column = 1,width = "2 cm") %>% 
      column_spec(column = 2,width = "11 cm") %>%
      column_spec(column = 3,width = "1 cm") %>%
      collapse_rows(columns = 1,valign = "middle")
```



## Final summary
```{r}
#sjmisc::descr(dat04w3,
#      show = c("label","range", "mean", "sd", "NA.prc", "n"))%>%
#      kable(.,"markdown")

print(dfSummary(dat04w3, valid.col = FALSE, graph.magnif = 0.75),
      max.tbl.height = 300, method = "render")

```

## save data

```{r}

save(dat04w3,file = "input/data/proc/data_s3_conv.RData")
```


# Invariance 


## Libraries
```{r}
pacman::p_load(haven, sjPlot, dplyr, lavaan, stargazer, corrplot, knitr, kableExtra, summarytools, sjlabelled,Hmisc,psych,tidyr)

```


## Load longitudinal data

 
```{r}
w01 <- sjlabelled::read_spss("input/data/original/Estudio_3_ola1.sav",verbose = F)
w02 <- sjlabelled::read_spss("input/data/original/Estudio_3_ola2.sav",verbose = F)
w03 <- sjlabelled::read_spss("input/data/original/Estudio_3_ola3.sav",verbose = F)
```

## Preparation wave 1

Add tags wave 1
```{r }
label(w01$Intro) <- "If you wish to participate, select the alternative I ACCEPT take part in this investigation. If you do not want to participate in this study, press the alternative I NOT ACCEPT take part in this investigation."
w01$Intro <- set_labels(w01$Intro,  labels = c("I ACCEPT take part in this investigation","I NOT ACCEPT take part in this investigation."))
```


Frequency of respondents who Accept and Finish wave 1.
```{r fig.width= 10}
w01_Intro <- w01 %>% select(Intro,Finished) %>% as.data.frame()
sjPlot::view_df(w01_Intro, show.type = T,show.frq = T, show.string.values = T, verbose = F, show.id = F)
```

Delete those who do not accept and Delete those who do not accept
```{r}
w01b <- w01 %>% filter(Intro==1, Finished==1) %>% as.data.frame()
w01b$ID<- stringr::str_split_fixed(w01b$ticket,"_", 4)[,1] # En la variable ticket el primer código es el ID, todo lo demás se borra
```

Frequency of respondents who Accept and Finish wave 1.
```{r fig.width= 20 }
w01b$Intro <- set_labels(w01b$Intro,  labels = c("I ACCEPT take part in this investigation", "I NOT ACCEPT take part in this investigation."))
w01_Introb <- w01b %>% select(Intro,Finished) %>% as.data.frame()
sjPlot::view_df(w01_Introb, show.type = T,show.frq = T, show.string.values = T, verbose = F, show.id = F)
```

A variable is created to indicate the order in which the items on the PPM scale are presented. The variables are renamed and those of interest are selected. The results are described.
```{r}
w01c <- w01b
w01c$grupo <- NA
w01c$grupo[w01c$FL_21_DO_merit_perc_pref_julio19v01==1] <- 1
w01c$grupo[w01c$FL_21_DO_merit_perc_pref_julio19v02==1] <- 2
w01c$grupo[w01c$FL_21_DO_merit_perc_pref_julio19v03==1] <- 3
w01c$perc_effort_w1 <- rowSums(w01c[,c(matches(match = "perc_effort",vars = names(w01c)))],na.rm = TRUE)
w01c$perc_talent_w1 <- rowSums(w01c[,c(matches(match = "perc_talent",vars = names(w01c)))],na.rm = TRUE)
w01c$perc_wpart_w1  <- rowSums(w01c[,c(matches(match = "perc_wpart" ,vars = names(w01c)))],na.rm = TRUE)
w01c$perc_netw_w1   <- rowSums(w01c[,c(matches(match = "perc_netw"  ,vars = names(w01c)))],na.rm = TRUE)
w01c$pref_effort_w1 <- rowSums(w01c[,c(matches(match = "pref_effort",vars = names(w01c)))],na.rm = TRUE)
w01c$pref_talent_w1 <- rowSums(w01c[,c(matches(match = "pref_talent",vars = names(w01c)))],na.rm = TRUE)
w01c$pref_wpart_w1  <- rowSums(w01c[,c(matches(match = "pref_wpart" ,vars = names(w01c)))],na.rm = TRUE)
w01c$pref_netw_w1   <- rowSums(w01c[,c(matches(match = "pref_netw"  ,vars = names(w01c)))],na.rm = TRUE)
w01c[w01c==0] <- NA
w01c <- w01c %>% select(grupo,
                        perc_effort_w1,perc_talent_w1,perc_wpart_w1,perc_netw_w1,
                        pref_effort_w1,pref_talent_w1,pref_wpart_w1,pref_netw_w1,
                        sexo_w1=sexo,edad_w1=edad,edcep_w1=edcep, ID)
#-----------------------------------------------------------------------#
print(dfSummary(w01c, valid.col = FALSE, graph.magnif = 0.75),
      max.tbl.height = 300, method = "render")
```


## Preparation wave 2

Add tags wave 2
```{r }
label(w02$Intro) <- "If you wish to participate, select the alternative I ACCEPT take part in this investigation. If you do not want to participate in this study, press the alternative I NOT ACCEPT take part in this investigation."
w02$Intro <- set_labels(w02$Intro,  labels = c("I ACCEPT take part in this investigation","I NOT ACCEPT take part in this investigation."))
```


Frequency of respondents who Accept and Finish wave 2.
```{r}
w02_Intro <- w02 %>% select(Intro,Finished) %>% as.data.frame()
sjPlot::view_df(w02_Intro, show.type = T,show.frq = T, show.string.values = T, verbose = F, show.id = F)
```

Delete those who do not accept and Delete those who do not accept
```{r}
w02b <- w02 %>% filter(Intro==1, Finished==1) %>% as.data.frame()
w02b$ID <- stringr::str_split_fixed(w02b$ticket, "_", 4)[,1]
```

Frequency of respondents who Accept and Finish wave 2.
```{r }
w02b$Intro <- set_labels(w02b$Intro,  labels = c("I ACCEPT take part in this investigation", "I NOT ACCEPT take part in this investigation."))
w02_Introb <- w02b %>% select(Intro,Finished) %>% as.data.frame()
sjPlot::view_df(w02_Introb, show.type = T,show.frq = T, show.string.values = T, verbose = F, show.id = F)
```

A variable is created to indicate the treatment to which the respondent was exposed. The variables are renamed and those of interest are selected. The results are described.

```{r}
w02c <- w02b
w02c$treat <- NA
w02c$treat[w02c$FL_6_DO_Control==1] <- 1
w02c$treat[w02c$FL_6_DO_Tratamiento==1] <- 2
w02c$treat[w02c$FL_6_DO_Tratamiento_desigualdad==1] <- 3
w02c$treat <- factor(w02c$treat,levels = c(1,2,3),labels = c("control","pobreza","desiguald"))
w02c <- w02c %>% rename(perc_effort_w2=meritv03_perc_effort,
                        perc_talent_w2=meritv03_perc_talent,
                        perc_wpart_w2 =meritv03_perc_wpart,
                        perc_netw_w2  =meritv03_perc_netw,
                        pref_effort_w2=meritv03_pref_effort,
                        pref_talent_w2=meritv03_pref_talent,
                        pref_wpart_w2 =meritv03_pref_wpart,
                        pref_netw_w2  =meritv03_pref_netw)
w02c <- w02c %>% select(perc_effort_w2,perc_talent_w2,perc_wpart_w2,perc_netw_w2,
                        pref_effort_w2,pref_talent_w2,pref_wpart_w2,pref_netw_w2,
                        sexo_w2=sexo,edad_w2=edad,edcep_w2=edcep, treat, ID)
#-----------------------------------------------------------------------#
print(dfSummary(w02c, valid.col = FALSE, graph.magnif = 0.75),
      max.tbl.height = 300, method = "render")
```


## Preparation wave 3


```{r}
table(w03$Finished==1)
w03b <- filter(w03,Finished==1) # Elimina los que no aceptan
dim(w03b)
w03b$ID <- stringr::str_split_fixed(w03b$ticket, "_", 4)[,1]
```

The variables of the PPM scale are renamed indicating the wave. Those of interest are selected. The results are described.
```{r}
w03c <- w03b
w03c <- w03c %>% rename(perc_effort_w3=meritv03_perc_effort,
                        perc_talent_w3=meritv03_perc_talent,
                        perc_wpart_w3 =meritv03_perc_wpart,
                        perc_netw_w3  =meritv03_perc_netw,
                        pref_effort_w3=meritv03_pref_effort,
                        pref_talent_w3=meritv03_pref_talent,
                        pref_wpart_w3 =meritv03_pref_wpart,
                        pref_netw_w3  =meritv03_pref_netw)
w03c <- w03c %>% select(perc_effort_w3,perc_talent_w3,perc_wpart_w3,perc_netw_w3,
                        pref_effort_w3,pref_talent_w3,pref_wpart_w3,pref_netw_w3,
                        sexo_w3=sexo,edad_w3=edad,edcep_w3=edcep, ID)
#-----------------------------------------------------------------------#
print(dfSummary(w03c, valid.col = FALSE, graph.magnif = 0.75),
      max.tbl.height = 300, method = "render")
```

## Merge wide data

```{r}
wide01 <- inner_join(x = w01c,y = w02c, by = "ID") 
dim(wide01) #en w01 y w02
```

```{r}
wide02 <- inner_join(x = wide01,y = w03c, by = "ID") 
dim(wide02) #en w01, w02 y w03
```

```{r}
print(dfSummary(w02, valid.col = FALSE, graph.magnif = 0.75),
      max.tbl.height = 300, method = "render")
```

```{r}
#save(wide01,file = "input/data/proc/datawide.RData")
#save(wide02,file = "input/data/proc/datawide_123.RData")
```

## Wide to long data

```{r}
library(datasets)
library(data.table)
wide <- setDT(wide02)
long01<- melt(wide,variable.name = "wave",
              measure = patterns("^perc_effort_","^perc_talent_","^perc_wpart_","^perc_netw_",
                                       "^pref_effort_","^pref_talent_","^pref_wpart_","^pref_netw_",
                                       "^sexo_","^edad_","^edcep_"),
              value.name = c("perc_effort","perc_talent","perc_wpart","perc_netw",
                             "pref_effort","pref_talent","pref_wpart","pref_netw",
                             "sexo","edad","edcep"))
#save(long01,file = "input/data/proc/datalong.RData")

```



## Factorial survey data:

Prepare poverty experiment data (wave 01):


```{r}
w01c <- w01 %>% filter(Intro==1) %>% as.data.frame()
w01c$ID<- stringr::str_split_fixed(w01c$ticket,"_", 4)[,1]
w01c$grupo <- NA
w01c$grupo[w01c$FL_21_DO_merit_perc_pref_julio19v01==1] <- 1
w01c$grupo[w01c$FL_21_DO_merit_perc_pref_julio19v02==1] <- 2
w01c$grupo[w01c$FL_21_DO_merit_perc_pref_julio19v03==1] <- 3
w01c$perc_effort_w1 <- rowSums(w01c[,c(matches(match = "perc_effort",vars = names(w01c)))],na.rm = TRUE)
w01c$perc_talent_w1 <- rowSums(w01c[,c(matches(match = "perc_talent",vars = names(w01c)))],na.rm = TRUE)
w01c$perc_wpart_w1  <- rowSums(w01c[,c(matches(match = "perc_wpart" ,vars = names(w01c)))],na.rm = TRUE)
w01c$perc_netw_w1   <- rowSums(w01c[,c(matches(match = "perc_netw"  ,vars = names(w01c)))],na.rm = TRUE)
w01c$pref_effort_w1 <- rowSums(w01c[,c(matches(match = "pref_effort",vars = names(w01c)))],na.rm = TRUE)
w01c$pref_talent_w1 <- rowSums(w01c[,c(matches(match = "pref_talent",vars = names(w01c)))],na.rm = TRUE)
w01c$pref_wpart_w1  <- rowSums(w01c[,c(matches(match = "pref_wpart" ,vars = names(w01c)))],na.rm = TRUE)
w01c$pref_netw_w1   <- rowSums(w01c[,c(matches(match = "pref_netw"  ,vars = names(w01c)))],na.rm = TRUE)
w01c[w01c==0] <- NA
w01c <- w01c %>% select(grupo,
                        perc_effort_w1,perc_talent_w1,perc_wpart_w1,perc_netw_w1,
                        pref_effort_w1,pref_talent_w1,pref_wpart_w1,pref_netw_w1,
                        sexo_w1=sexo,edad_w1=edad,edcep_w1=edcep, ID)
```


```{r}
w01fs <- w01c
names(w01fs)<- stringr::str_replace_all(string = names(w01fs),pattern = "_w1",replacement = "") 
```

Prepare factorial survey data (wave 02):

```{r}
# fs01 <- sjlabelled::read_spss("input/data/original/factorial_ola2.sav",verbose = F)
load(file = "papelera/input/data/original/factorial_ola2.RData") 
```

```{r}
names(long01)
fs02 <- fs01 %>% 
  filter(consen==1) %>% 
  mutate(grupo=4,ID=ResponseId,) %>% 
  select(grupo,ID,"perc_effort"="merit_perc_effort",
         "perc_talent" = "merit_perc_talent",
         "perc_wpart" = "merit_perc_wpart",
         "perc_netw"  = "merit_perc_netw",
         "pref_effort" = "merit_pref_effort",
         "pref_talent" = "merit_pref_talent",
         "pref_wpart" = "merit_pref_wpart",
         "pref_netw"  = "merit_pref_netw",
         sexo,edad,
         edcep=educ)
```


Identify dataset of origin:

```{r}
w01fs$dataset <- "pvw01"
fs02$dataset  <- "fsw02"
```

Merge data sets:

```{r}
data_s3_inv<-bind_rows(fs02,w01fs) %>%
  set_label(label = get_label(fs02)) %>%
  set_labels(labels = get_labels(fs02))
```

```{r}
save(data_s3_inv,file = "input/data/proc/data_s3_inv.RData")
```


